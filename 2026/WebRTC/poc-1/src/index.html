<!DOCTYPE html>
<html>
<head>
    <title>WebRTC Data Channel PoC</title>
</head>
<body>
    <h1>WebRTC Data Channel Test</h1>
    <div>
        <button id="connect">Connect to Signaling</button>
        <button id="createOffer">Create Offer (Client A)</button>
    </div>
    <div id="status">Status: Idle</div>
    <textarea id="message" placeholder="Type a message"></textarea>
    <button id="send" disabled>Send</button>
    <div id="logs" style="border: 1px solid #ccc; height: 200px; overflow-y: scroll; margin-top: 10px; padding: 5px;"></div>

    <script>
        let pc;
        let dc;
        let ws;
        const log = (msg) => {
            const div = document.createElement('div');
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            document.getElementById('logs').appendChild(div);
        };

        document.getElementById('connect').onclick = () => {
            ws = new WebSocket('ws://' + window.location.host);
            ws.onopen = () => log('Connected to signaling server');
            ws.onmessage = async (e) => {
                const data = JSON.parse(e.data);
                if (data.sdp) {
                    log(`Received ${data.sdp.type}`);
                    if (!pc) setupPeerConnection();
                    await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
                    if (data.sdp.type === 'offer') {
                        const answer = await pc.createAnswer();
                        await pc.setLocalDescription(answer);
                        ws.send(JSON.stringify({ sdp: pc.localDescription }));
                    }
                } else if (data.candidate) {
                    log('Received ICE candidate');
                    await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
                }
            };
        };

        const setupPeerConnection = () => {
            pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
            pc.onicecandidate = (e) => {
                if (e.candidate) ws.send(JSON.stringify({ candidate: e.candidate }));
            };
            pc.ondatachannel = (e) => {
                log('Received data channel');
                setupDataChannel(e.channel);
            };
        };

        const setupDataChannel = (channel) => {
            dc = channel;
            dc.onopen = () => {
                log('Data channel opened');
                document.getElementById('send').disabled = false;
                document.getElementById('status').textContent = 'Status: Connected';
            };
            dc.onmessage = (e) => log(`Received: ${e.data}`);
        };

        document.getElementById('createOffer').onclick = async () => {
            setupPeerConnection();
            dc = pc.createDataChannel('test');
            setupDataChannel(dc);
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            ws.send(JSON.stringify({ sdp: pc.localDescription }));
            log('Offer sent');
        };

        document.getElementById('send').onclick = () => {
            const msg = document.getElementById('message').value;
            dc.send(msg);
            log(`Sent: ${msg}`);
        };
    </script>
</body>
</html>
