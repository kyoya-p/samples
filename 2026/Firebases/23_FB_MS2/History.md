# プロジェクト履歴: Firebase C++ SDK TUI サンプル

## 初期セットアップと依存関係
- CMake/C++17, FTXUI, Firebase C++ SDK の統合。
- Linux/Windows 両対応のビルド環境構築。

## 実装の変遷 (要約)

### フェーズ 1-10: 基礎構築と初期安定化
- **基本機能**: Firestore 連携（リアルタイム監視）、連絡先追加/削除、ランダムデータ生成を実装。
- **UI/UX**: スクロールリスト、フッター固定、入力フィールド化、動的ページサイズ計算を導入。
- **堅牢性**: リスナーの適切な解除、gRPC シャットダウン処理の安定化、例外ハンドリングの追加。
- **環境**: API Key による初期化（環境変数/設定ファイル）、マルチプラットフォーム対応の開始。

### フェーズ 11-22: 最適化・自動化・MSVC対応
- **自動テスト**: `tui-test` (PTY) による自動検証環境の整備。
- **データ管理**: 完全バッファレス（オンデマンド取得）、10件単位の厳格なページング制御を実装し、通信・メモリ効率を極限化。
- **Windows (MSVC)**: 参照キャプチャによるアクセス違反の修正、時刻処理の再入可能性確保、システムライブラリのリンク完備。
- **拡張**: メインメニュー、アドレス帳ピッカー（ソート・フィルタ機能付）、マルチプロセス実行（PIDベースのApp名）をサポート。
- **検証機能**: ヘッドレス環境向けのスナップショット出力 (`Ctrl-p`)、診断キーの追加。

### フェーズ 23: メイン関数の構造的分解と正常化
- **関数の細分化**: 肥大化していた `main` 関数を、役割ごとに小規模な関数（`RefreshAddressList`, `LoadApiKey` 等）に分解。
- **AppState**: 状態管理用構造体を導入し、グローバル変数を整理。
- **コンポーネント所有権**: `rows` (Container) と `rows_c` (Decorator) の親子関係を正しく再定義し、描画を正常化。

### フェーズ 24: Windows Terminal環境における外部自動化の知見
- **プロセス構造**: Windows Terminal (`WindowsTerminal.exe`) 環境下では、`pwsh.exe` は独自のウィンドウハンドルを持たず、親である Terminal プロセスが描画を管理していることを特定。
- **外部操作**: 親プロセスに対して `SendKeys` を送ることで、内部のシェルを操作可能であることを実証。
- **TUIの入力特性**: FTXUI 等の TUI アプリは標準的な Win32 メッセージを無視し、コンソール入力バッファを参照するため、`PostMessage` ではなく PTY 経由や親へのキー送信が有効。

### フェーズ 25: UI/UXの洗練と診断機能の強化
- **視覚的ノイズ削減**: `name`, `time`, `op` カラムのホバー・フォーカス反転表示を廃止し、シンプルで一貫性のある外観に変更。
- **選択状態の改善**: 行選択インジケータ `>` を行頭（Name）に移動。
- **メンテナンス性**: 全関数に役割を示す1行コメントを付与。
- **診断ツール**: Windows API を利用し Terminal 領域を PNG 保存する `capture_terminal.ps1` を作成。

### フェーズ 26: 外部検証環境の確立と最終統合
- **画面キャプチャの制約回避**:
    - Windows Terminal の GPU レンダリング（AtlasEngine）により、従来のウィンドウ単位の GDI キャプチャでは内容が「真っ黒」になる問題を特定。
    - ウィンドウを前面に強制フォーカス（`SetForegroundWindow`）させた上で、**デスクトップ全体のキャプチャ**（`CopyFromScreen`）を行うことで、GPU 描画内容を画像エビデンスとして採取する手法を確立。
- **自動操作の安定化**:
    - `wt.exe` 起動時のパス解釈の差異を解決するため、バイナリパスをフルパス（`Resolve-Path`）で渡すように修正。
- **最終統合検証の成功**:
    - PowerShell 経由でアプリを起動し、Firebase へのリアルタイム接続（`Status: Connected`）および、UI 修正（カラム反転の廃止）が画像上で正しく反映されていることを視覚的に確認。