# ソフトウェア設計

## ソースファイル構造

- src/main/*  : アプリコード
- src/test/*  : Testコード

## 5.1. データベース設計 (Firestore)
- **コレクション**: `addressbook`
- **ドキュメント構造**:
    ```json
    {
      "name": "String (Document IDとしても使用)",
      "email": "String",
      "timestamp": "ServerTimestamp"
    }
    ```
## 5.2. データ転送
- **アドレス取得データ単位**
  - ターミナル画面サイズから算出 (`nAddress`)
  - 初回取得時は、画面を確実に埋めて不要な追加読み込みを防ぐため、「画面の高さ + 予備バッファ(5行)」を1ページとして取得する。
- **効率化のポイント**
  - 一度の取得数が少なすぎると、初期表示だけで複数回の通信が発生し非効率。
  - 一度の取得数が多すぎると、表示されない無駄なデータを取得することになる。
  - 上記の計算により、初期表示に必要な最小限かつ十分なデータを1回のクエリで取得する。
- **ページング制御 (無限スクロール)**
  -以下のような表示範囲が変化した場合、次のアドレスをクエリ取得する。
    - ユーザーがスクロール
    - ターミナルサイズ変更
  - ページングには Firestore のカーソル機能 (`startAfter`) を使用し、直前のページの最後のデータ以降を取得する。

## 5.3. マルチプラットフォーム対応
- **抽象化レイヤー**:
    - OS固有の処理（PID取得、スタックトレース、標準関数）は `utils.hpp/cpp` でラップし、条件付きコンパイル (`#ifdef _WIN32`) で吸収する。
- **Windows (MSVC) 対応**:
    - **マクロ衝突回避**: Windows API (`windows.h`) の `RGB` マクロが FTXUI の `Color::RGB` と衝突するため、インクルード後に `#undef RGB` を行う。
    - **ランタイムライブラリ**: Firebase C++ SDK との整合性を保つため、動的リンクライブラリ (`MD`) を優先的に使用する。
    - **システムリンクター**: Windows では `bcrypt`, `ws2_32`, `rpcrt4`, `ole32` などのシステム .lib を明示的にリンクする。

## 5.4. 安全性と堅牢性
- **メモリ管理 (Lambda Capture)**:
    - FTXUIのコンポーネントツリーは非同期にレンダリングされるため、コールバック内でのローカル変数への参照キャプチャ (`[&]`) は避け、常に値キャプチャ (`[=]`) または `shared_ptr` による寿命管理を行う。これにより、関数スコープ終了後のアクセス違反 (Access Violation) を防止する。
- **スレッド安全性**:
    - **時刻処理**: 標準の `std::localtime` は内部バッファを共有するため、バックグラウンドスレッド（Firebaseコールバック）での使用は危険である。Windows では `localtime_s`、POSIX では `localtime_r` を使用して再入可能性を確保する。
    - **UI更新ガード**: UIループ (`screen.Loop`) が開始される前に別スレッドから `screen.Post` が呼ばれるのを防ぐため、`std::atomic<bool>` フラグによる実行制御を行う。

## ログ・デバッグ
- **ファイル出力**: `app.log` 形式のファイルに実行ログを記録。
- **例外処理**: Windows では `SetUnhandledExceptionFilter` を使用し、クラッシュ時にコンソールの状態（代替バッファ、カーソル）を強制復帰させるハンドラを登録している。
- **検証モード**: `--snapshot` モードにより、非対話環境での描画および通信の健全性を自動検証可能。
