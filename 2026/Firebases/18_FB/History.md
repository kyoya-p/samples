# プロジェクト履歴: Firebase C++ SDK TUI サンプル

## 初期セットアップと依存関係
- **プロジェクト構造**: 標準的な CMake プロジェクト構造を構築。
- **CMake設定**:
    - C++17 を必須に設定。
    - `FetchContent` を使用して **FTXUI** (v5.0.0) を統合。
    - `build/sdk/firebase_cpp_sdk/libs/linux/x86_64/cxx11` にある Firebase C++ SDK の静的ライブラリ (`libfirebase_firestore.a`, `libfirebase_app.a` 等) を手動でリンク。
    - 必要なシステム依存ライブラリをリンク: `curl`, `openssl`, `zlib`, `libsecret-1` (pkg-config経由), `dl`, `pthread`。

## 実装の変遷

### フェーズ 1: 基本UIとFirebase連携
- **UIデザイン**: FTXUIを使用し、提供されたSVGレイアウトを模したターミナルUIを実装。
    - ヘッダー: Name, Mail Address, Operation。
    - ボディ: 連絡先の動的リスト。
    - フッター: 総件数と終了ボタン。
- **Firebase統合**:
    - Firebaseロジックを扱う `FirestoreService` クラスを作成。
    - `Initialize()` で `firebase::App` と `firebase::firestore::Firestore` を生成。
    - `addressbook` コレクションに対して `AddSnapshotListener` を使用し、リアルタイム更新を受信。
    - ランダムな名前・メールアドレスでドキュメントを追加する `AddRandomContact()` を実装。
    - ID指定でドキュメントを削除する `RemoveContact()` を実装。

### フェーズ 2: 設定とエラーハンドリング
- **環境変数**: 当初は `google-services.json` に依存していたが、API Key を用いて `firebase::AppOptions` で手動設定する方法に変更。
- **起動ロジック**:
    - 初期は環境変数 `API_KEY` がない場合に強制的に入力画面を表示していた。
    - キーがない場合は「未接続」状態でアプリを開始できるようにリファクタリング。
- **UI改善**:
    - メインフッターに `[Activate]` ボタンを追加。
    - 実行中に API Key を入力・変更するためのモーダル（オーバーレイ）画面を実装。
    - 接続状態（Connected/Disconnected）とエラーメッセージの表示エリアを追加。
    - `q` キーでのアプリケーション終了をサポート。

### フェーズ 3: レイアウトとUXの改善
- **スクロール可能なリスト**: データ量が増えても対応できるよう、連絡先リストをスクロール可能なコンテナ (`vscroll_indicator | frame | flex`) でラップ。
- **フッター固定**: 「追加」行（入力欄+ボタン）とフッター（ステータス+終了ボタン）が常に画面下部に表示されるよう `flex` レイアウトで調整。
- **入力フィールド**: 「追加」行を `ftxui::Input` コンポーネントに変更し、ランダム生成された値をユーザーが確認・編集してから追加できるようにした。
- **自動再生成**: 連絡先追加成功後、直ちに次のランダムな値を生成して入力欄を更新するロジックを実装。

### フェーズ 4: 安定性とリソース管理
- **リスナーのクリーンアップ**: `firebase::firestore::ListenerRegistration` を導入し、スナップショットリスナーを適切に管理。
- **安全な終了処理**: `Cleanup()` メソッドを実装（デストラクタおよび再初期化時に呼び出し）。
    1. Firestore リスナーの解除 (`registration_.Remove()`)。
    2. `firebase::App` インスタンスの削除。
- **クラッシュ修正**: リスナーを明示的に解除してから App を破棄することで、gRPC のシャットダウンタイムアウトやセグメンテーションフォールトを解決。依存オブジェクトの手動削除を回避。
- **ロギング**: TUIの表示を崩さずに実行ログやエラーを追跡できるよう、ファイルベースのロガー (`app.log`) を追加。
- **永続化無効化**: 複数プロセスでの同時実行を可能にするため、Firestore の永続化設定 (`set_persistence_enabled(false)`) を適用。

### フェーズ 5: 高度なリスト制御とUI調整
- **無限スクロール (Infinite Scroll)**:
    - リストの末尾が表示されたことを検知する `VisibilityObserver` コンポーネントを実装。
    - ユーザーがスクロールして最後の要素が見えると、自動的に次のデータを取得 (`LoadMore`) するシームレスな挙動を実現。
    - 取得単位を 10件 に設定。
    - データの終端に達したら `last of data` を表示。
- **カラム幅の厳格化**:
    - `Name`: 30文字固定。
    - `Address`: 可変 (`flex`)。
    - `Time`: 20文字固定（作成時刻用）。
    - `Operation`: 14文字固定。
    - ヘッダー、データ行、入力行すべてでこの比率を統一し、垂直方向の罫線を整列。
- **フォーカスと操作性**:
    - `Operation` (Removeボタン) にフォーカスがある時、行全体を反転表示して視認性を向上。
    - `VisibilityObserver` にイベント委譲を追加し、リスト内のフォーカス移動やスクロール操作が阻害されないように修正。
- **ドキュメントID**: ランダム生成された `Name` をそのまま Firestore の Document ID として使用するように変更。
- **作成時刻の追加**: `timestamp` フィールドを追加し、Firestore サーバータイムスタンプを使用。リストは作成時刻順にソート。
- **ログ管理の強化**:
    - 起動ごとに日時付きログファイル (`app.YYMMDD-HHMM.log`) を生成。
    - 例外発生時のスタックトレース出力を実装。
    - `THROW_LOG` マクロの導入。

### フェーズ 6: UIの最終調整と配布準備
- **UI整合性の確保**:
    - `Name` カラム幅を 28、`Time` を 16、`Operation` を 10 に微調整し、全体のバランスを最適化。
    - `[Exit]` ボタンを `[Close]` に変更 (`Readme.md` 準拠)。

### フェーズ 7: 効率的なデータ転送と堅牢性の向上
- **ページング・リスナーの実装**:
    - 通信効率向上のため、単一のクエリ制限を増やす方式から、10件ごとの「ページ」単位で独立したリスナーを管理する方式へリファクタリング。
    - `StartAfter` を使用し、既存データを再取得せずに新しいページのみを読み込むことで帯域と読み込みコストを最適化。
- **シャットダウンの安定化**:
    - Firestore インスタンスを `firebase::App` より先に明示的に破棄するように修正（SDKの警告に対応）。
    - リスナー解除から App 破棄の間に待機時間 (200ms) を設け、gRPC スレッドの安全な終了を保証。gRPC のシャットダウンタイムアウトを解消。
- **未確定タイムスタンプのエラー回避**:
    - ローカルで追加直後の「未確定 (pending)」なサーバータイムスタンプを持つドキュメントをクエリのカーソル (`StartAfter`) に使用すると発生する致命的エラーを修正。
    - `has_pending_writes()` をチェックし、同期が完了するまで次のページの読み込みを待機するガードロジックを追加。
- **デバッグ機能の強化**:
    - 実行された Firestore クエリの詳細（コレクション、リミット、カーソルID）をログに出力。
    - ログの第2フィールドにプロセスID (PID) を追加し、複数インスタンス実行時のログ追跡を容易にした。

### フェーズ 8: 画面適応型ページングとUX最適化
- **動的ページサイズ計算**:
    - 初回データ取得数 (`nAddress`) を「ターミナル高さ + 5行」で算出するように変更。
    - これにより、アプリ起動直後に読み込み検知器（Loading...）が画面外に押し出され、不要な2ページ目以降の自動読み込み（通信の連鎖）を防止。
- **リサイズ・スクロール対応**:
    - `LoadMore` 呼び出し時に、その瞬間のターミナルサイズに基づいて最適な取得件数を再計算するロジックを実装。
    - ウィンドウサイズが変更されても、常に画面を埋めるのに十分なデータを効率的に取得可能にした。
- **ログ仕様の変更**:
    - ログファイル名を固定の `app.log` に変更し、ファイル管理を簡素化。

### フェーズ 8: CI/CD向け検証機能とビルド修正
- **ビルド構成の修正**:
    - `CMakeLists.txt` の Firebase SDK パス設定を修正し、ダウンロードされたディレクトリ構造に正しく追従するように変更。これによりビルドエラーを解消。
- **CLI検証モードの追加**:
    - `--check` フラグ: TUIを起動せず、バイナリが正常に初期化できるかを検証して即座に終了するモードを追加。CI環境でのスモークテスト用。
    - `--snapshot` フラグ: UIコンポーネントを構築し、現在の画面状態をテキストとして標準出力（ログ）にダンプして終了するモードを追加。
- **スナップショットモードの実装**:
    - `main.cpp` をリファクタリングし、UI構築ロジックを `ScreenInteractive` のイベントループから分離.
    - インタラクティブなコンポーネント（`Input`, `Button`）が非対話モードでレンダリングされる際のクラッシュを回避するため、スナップショットモード時はテキストプレースホルダーに置換するロジックを実装.
    - これにより、ヘッドレス環境でもTUIのレイアウト崩れがないかを自動検証可能にした.

### フェーズ 9: Windows (MSVC) 移植と安定性の向上
- **MSVC ビルド対応**: 
    - `CMakeLists.txt` を大幅に修正し、Windows環境 (Visual Studio 2022 / BuildTools) でのコンパイルをサポート。
    - Windows版 Firebase C++ SDK のディレクトリ構造 (`libs/windows/VS2019/MD/x64/Release`) に合わせたライブラリパス設定を追加。
- **依存ライブラリの完備**:
    - Windows特有のシステムライブラリ (`bcrypt`, `crypt32`, `ws2_32`, `advapi32`, `shlwapi`, `rpcrt4`, `ole32` 等) をリンク対象に追加し、実行時エラーを解消。
- **メモリ安全性の確保 (重要)**:
    - FTXUIのコールバックにおいて、ローカル変数の「参照キャプチャ (`[&]`)」が原因で発生していたアクセス違反 (Access Violation) を、安全な「値キャプチャ (`[=]`)」に修正。
- **スレッド安全性の向上**:
    - 共有データアクセス用の `mutex` 保護に加え、非スレッドセーフな `std::localtime` を `localtime_s` (Windows) / `localtime_r` (POSIX) に置換。
    - UIループ開始前にバックグラウンドから `screen.Post` が呼ばれることによるクラッシュを防ぐため、`std::atomic<bool> started` フラグによるガードを導入。
- **デバッグ機能の強化**:
    - `--snapshot` モードを拡張し、Firestoreからのデータ受信を最大6秒間待機するロジックを実装。これにより、ヘッドレス環境でも実際の通信成功を検証可能にした。
- **非対話環境の特定**: 
    - 自動実行ツール内でのクラッシュが、アプリケーションの不具合ではなく、FTXUIが要求する「対話型TTY」の不在によるものであることを特定・分離。

### フェーズ 11: 自動テスト環境の整備とセキュリティ強化
- **秘匿情報の排除**:
    - 全てのテストファイル (`testspec/*.spec.ts`) からハードコードされていた API Key を削除。
    - 環境変数 `process.env.API_KEY` から取得する方式に統一し、セキュリティを向上。
- **テストの相対パス化**:
    - 実行バイナリのパス (`appPath`) を絶対パスから `process.cwd()` を基点とした相対パスに変更。環境に依存せずテスト実行を可能にした。
- **新規テストシナリオの追加**:
    - `1.3_activation.spec.ts`: APIキー未設定状態からの「[Activate] ダイアログ入力 → 接続成功」の一連のフローを検証。
    - `1.4_add_contact.spec.ts`: 連絡先追加ボタン押下により、入力フィールドが次のランダム名に更新される（＝アプリがアクションを受理する）ことを検証。
- **gRPC/Firebase ログの制御**:
    - 自動テスト（スナップショット）のノイズとなる Firebase SDK の内部警告ログを抑制するため、`SetLogLevel` を `kLogLevelAssert` に引き上げ。
    - gRPC 内部の stderr 出力を抑制するため、初期化時に環境変数 `GRPC_VERBOSITY=NONE` を設定するロジックを `dataaccess.cpp` に追加。
- **接続安定性の向上**:
    - 再初期化時のリソース競合を防ぐため、`Cleanup()` 時の待機時間を 200ms から 500ms ＋ App削除後 500ms に延長。OSレベルでのソケット解放待ちを考慮。

### フェーズ 12: 機能整理とプロジェクト構造の刷新
- **ディレクトリ構造の整理**:
    - ソースコードを `src/main/`、テストコードを `src/test/` に移動し、プロジェクト構成を標準的な形式に刷新。
    - これに伴い `CMakeLists.txt` および `tui-test.config.ts` のパス設定を更新。
- **不要な検証モードの廃止**:
    - 実装が複雑化していた `--snapshot` モードおよび `--check` モードを廃止。TUIテスト（`tui-test`）による自動検証に一本化。
- **ログ機能のスレッド安全性向上**:
    - `utils.cpp` の `Log` 関数において、非推奨かつ非スレッドセーフな `std::localtime` を、プラットフォーム固有の安全な関数（`localtime_s` / `localtime_r`）に置換。
- **ドキュメントの同期**:
    - `SoftwareDesign.md` から廃止された機能（検証モード）の記述を削除し、新しいディレクトリ構造を反映。

### フェーズ 13: UI更新処理の修正 (MSVC対応)
- **ビルドエラーの修正**:
    - `ScreenInteractive` (non-copyable) をラムダ式でコピーキャプチャ (`[=]`) していた箇所を、参照キャプチャ (`[&screen]`) に修正し、MSVCでのビルドエラー (C2280) を解消。
- **UI自動更新の修正**:
    - データ更新通知の `screen.Post([]{})` (空タスク) がUIの再描画を正しくトリガーしない問題を特定。
    - `screen.Post(Event::Custom)` を発行し、メインループの `CatchEvent` で明示的に `refresh_address_list` を呼び出す方式に変更。これにより、Firestore からのデータ受信時に連絡先リストが即座に反映されるようになった。
- **ユーザーフィードバックの強化**:
    - アドレスブック画面のフッターにエラーメッセージ表示エリアを追加。接続エラーやAPIキーの問題をユーザーが視認できるように改善。

### フェーズ 14: 多機能メニューとアドレス帳選択機能の強化
- **メインメニューの実装**:
    - アプリ起動時の画面をメインメニュー（ダッシュボード）に変更。
    - [Scan & Send] と [Address Book Edit] の2つの機能へのナビゲーションを提供。
    - ステータス表示と接続設定 ([Activate]) を常時アクセス可能なフッターに配置。
- **設定ファイルのサポート**:
    - `app.conf` から API Key を読み込む機能を追加。環境変数がない場合でも設定を永続化可能にした。
- **アドレス帳選択 (Picker) の刷新**:
    - 単なるリスト表示から、多機能な選択ダイアログへアップグレード。
    - **ソート機能**: Name, Mail, Time の各カラムをクリックして昇順・降順の切り替えが可能。
    - **フィルタ機能**: Name, Mail に対するリアルタイムフィルタリング（部分一致検索）を実装。
    - **UIレイアウトの調整**:
        - カラムヘッダーに合わせて検索入力フィールドを配置。
        - 選択されたカラムの入力フィールドのみを表示・有効化し、他は非表示にする動的レイアウトを採用。
        - リストアイテムの表示を固定幅パディングで整列させ、視認性を向上。
    - **状態遷移の最適化**:
        - カラム切り替え時に、関係のないフィルタ条件を自動クリアするようにロジックを改良。

### フェーズ 15: 実行ファイル名の変更
- **バイナリ名称の統一**:
    - 実行ファイル名を `FirebaseApp.exe` から `AddrApp.exe` に変更。
    - `CMakeLists.txt` および `Readme.md` の記述を更新。

### フェーズ 16: クエリ発行の最適化
- **シームレスな自動読み込みの導入**:
    - リスト末尾に表示していた「(More items available)」ラベルを廃止。
    - 代わりに「Loading...」プレースホルダーを配置し、それが描画されたタイミング（＝ユーザーがリストの末尾を表示した時）に自動で `LoadMore` を実行する仕組みに変更。
    - これにより、ターミナルの高さに関わらず、必要な分だけが順次読み込まれるUXを実現。

